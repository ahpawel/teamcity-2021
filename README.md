# Temcity Trial 2017

## Quick start

```bash
docker-compose up
```

Teamcity runs on [port 8111](http://localhost:8111). In case of permission issues you can try to boot up again. Otherwise you can bootup in background.

```bash
docker-compose up -d
```

## Configuration

1. Download Postgres driver JDBC 42 `https://jdbc.postgresql.org/download/postgresql-42.2.23.jar`
and copy it into `teamcity/data/lib/jdbc`
1. Create dir `repos`
1. Init new repository named `git init teamcity-settings`
1. Create repository server `git clone --bare ./teamcity-settings teamcity-settings.git`
1. Remove newly created repository `rm -rf teamcity-settings`
1. Go to `<Root project>` settings and [add new VCS](http://localhost:8111/admin/editProject.html?projectId=_Root&tab=projectVcsRoots) with Repository URL set to:`/repos/teamcity-settings.git`
1. Enable [synchronization](http://localhost:8111/admin/editProject.html?projectId=_Root&tab=versionedSettings) and set Settings format to Kotlin (`Overwrite settings in VCS`)
1. Click `Commit current project settingsâ€¦`
1. Clone settings repository to make changes i.e. `git clone ../repos/teamcity-settings.git`

To activate an agent go to Agents > [Unauthorized](http://localhost:8111/agents.html?tab=unauthorizedAgents) and click Authorize near the agent.

## Playground

The easiest way to experiment with DSL in TeamCity 2017.2+ is to edit settings in UI and check the UI diff script generated by TeamCity. Locally, you can play and break as you like.

1. Turn off synchronization on the project (It cannot be a subproject.)
1. Play time - configure project from UI
1. Save configuration into zip (in case of sync failure)
    1. Go to `Edit Configuration Settings`
    1. Click `Actions > Download settings in Kotlin format`
1. Apply config in the repo from downloaded files
1. Verify
1. Push changes to repository server
1. Turn back on the synchronization (`Use settings from a parent project` > `Import project settings from VCS`)

You can also copy the project and change it simultaneously along the configuration in the repo.

To test own app you can create another repo server in `repos`.

## Test

To run test execute:

```bash
docker run -it --rm -v "$(pwd)/.m2":/root/.m2 -v "$(pwd)":/usr/src/tc -w /usr/src/tc maven:3.3-jdk-8 mvn clean test
```

## Preperation before the first build

1. Login to docker https://www.jetbrains.com/help/teamcity/docker-support.html

## Clean-up

- Remove configuration files: `rm -rf agents teamcity postgres`
- Remove docker containers: `docker-compose down`

## LINKS

- [Teamcity Documentation](https://www.jetbrains.com/help/teamcity/teamcity-documentation.html)
- [Installation instructions](https://www.jetbrains.com/help/teamcity/installation.html)
- [Postgres recommendations](https://www.jetbrains.com/help/teamcity/how-to.html#Configure+Newly+Installed+PostgreSQL+Server)

## BLOB

- Teamcity docker image size: 1.73 GB
- Internal database which is not recommended [for production](https://www.jetbrains.com/help/teamcity/setting-up-an-external-database.html#Default+Internal+Database)
- Runing docker in docker is not recommended http://jpetazzo.github.io/2015/09/03/do-not-use-docker-in-docker-for-ci/
- Teamcity Setup by CodeMaze https://code-maze.com/preparing-ci-environment-docker/

## Documentation

- [teamcity DSL documentation](https://teamcity.jetbrains.com/app/dsl-documentation/index.html)
